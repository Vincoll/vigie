# docker-compose -f ./DC_vigie_test.yml up -d
version: "3.9"

name: vigie-backend
networks:
  vigie:
    external: true

services:

# ----------------------------------------------------------------------------------------
#  PULSAR
# ----------------------------------------------------------------------------------------
#
# https://hub.docker.com/r/apachepulsar/pulsar

  pulsar:
    image: apachepulsar/pulsar:3.2.0
    container_name: VIGIE-CI_pulsar
    restart: "no"
    entrypoint: bin/pulsar
    command:
      - standalone
    ports:
      - "8080:8080"
      - "6650:6650"
    volumes:
      - ./configs/pulsar_worker:/pulsar_worker/conf
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pulsar.rule=Host(`pulsar.localhost`)"
      - "traefik.http.routers.pulsar.entrypoints=web"
    networks:
      - vigie

# ----------------------------------------------------------------------------------------
#  CockroachDB
# ----------------------------------------------------------------------------------------
#
# https://hub.docker.com/r/cockroachdb/cockroach/tags

  cockroachdb:
    image: cockroachdb/cockroach:latest-v23.1
    container_name: VIGIE-CI_cockroach

    ports:
      - "8080"
      - "26257:26257"
    command: start-single-node --insecure=false
    volumes:
      - ./configs/sql:/tmp/init
    #      - "${PWD}/cockroach-data/crdb:/cockroach/cockroach-data"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cockroachdb.rule=Host(`cdb.localhost`)"
      - "traefik.http.routers.cockroachdb.entrypoints=web"
    networks:
      - vigie

  # ----------------------------------------------------------------------------------------
  #  Postgres
  # ----------------------------------------------------------------------------------------
  #
  # https://hub.docker.com/_/postgres

  pg:
    image: postgres:16.1
    container_name: VIGIE-CI_pg
    ports:
      - "6432:5432"
    volumes:
      - ./configs/sql/db_init.sql:/docker-entrypoint-initdb.d/db_init.sql
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
      # User and DB are created in a db-init.sql file

# ----------------------------------------------------------------------------------------
#  ZOOKEEPER
# ----------------------------------------------------------------------------------------

#  zoo1:
#    image: zookeeper:3.8
#    container_name: VIGIE-CI_zoo1
#    restart: always
#    hostname: zoo1
#    ports:
#      - "2181:2181"
#    environment:
#      ZOO_MY_ID: 1
#      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181
#
#  zoo2:
#    image: zookeeper:3.8
#    container_name: VIGIE-CI_zoo2
#    restart: always
#    hostname: zoo2
#    ports:
#      - "2182:2181"
#    environment:
#      ZOO_MY_ID: 2
#      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181
#
#  zoo3:
#    image: zookeeper:3.8
#    container_name: VIGIE-CI_zoo3
#    restart: always
#    hostname: zoo3
#    ports:
#      - "2183:2181"
#    environment:
#      ZOO_MY_ID: 3
#      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181

# ----------------------------------------------------------------------------------------
#  ETCD
# ----------------------------------------------------------------------------------------

  etcd1:
    image: quay.io/coreos/etcd:v3.5.10
    container_name: VIGIE-CI_etcd1
    restart: "no"
    ports:
      - 2379:2379
      - 2380:2380
      - 23791:2379
      - 23801:2380
    environment:
      ETCD_NAME: node1
      ETCD_DATA_DIR: /etcd-data/etcd1.etcd
      ETCDCTL_API: 3
      ETCD_DEBUG: 1
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd1:2380
      ETCD_INITIAL_CLUSTER: node3=http://etcd3:2380,node1=http://etcd1:2380,node2=http://etcd2:2380
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_INITIAL_CLUSTER_TOKEN: webapi-etcd
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd1:2379
    networks:
      - vigie

  etcd2:
    image: quay.io/coreos/etcd:v3.5.10
    container_name: VIGIE-CI_etcd2
    restart: "no"
    ports:
      - 23792:2379
      - 23802:2380
    environment:
      ETCD_NAME: node2
      ETCD_DATA_DIR: /etcd-data/etcd2.etcd
      ETCDCTL_API: 3
      ETCD_DEBUG: 1
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd2:2380
      ETCD_INITIAL_CLUSTER: node3=http://etcd3:2380,node1=http://etcd1:2380,node2=http://etcd2:2380
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_INITIAL_CLUSTER_TOKEN: webapi-etcd
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd2:2379
    networks:
      - vigie

  etcd3:
    image: quay.io/coreos/etcd:v3.5.10
    container_name: VIGIE-CI_etcd3
    restart: "no"
    ports:
      - 23793:2379
      - 23803:2380
    environment:
      ETCD_NAME: node3
      ETCD_DATA_DIR: /etcd-data/etcd3.etcd
      ETCDCTL_API: 3
      ETCD_DEBUG: 1
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd3:2380
      ETCD_INITIAL_CLUSTER: node3=http://etcd3:2380,node1=http://etcd1:2380,node2=http://etcd2:2380
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_INITIAL_CLUSTER_TOKEN: webapi-etcd
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd3:2379
    networks:
      - vigie
